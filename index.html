<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OmnI: Tomorrow</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon"/>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@400;700&family=Montserrat:wght@400;700&family=Raleway:wght@400;700&family=Poppins:wght@400;700&family=Orbitron:wght@400;700&family=Playfair+Display:wght@400;700&family=Lobster&family=Open+Sans:wght@400;700&family=Nunito:wght@400;700&family=Merriweather:wght@400;700&family=Rubik:wght@400;700&family=Inter:wght@400;700&family=Fira+Sans:wght@400;700&family=Fira+Mono:wght@400;700&family=Inconsolata:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Press+Start+2P&family=Audiowide&family=Share+Tech+Mono&family=VT323&family=Rajdhani:wght@400;700&family=Electrolize&family=Oxanium:wght@400;700&family=Quantico:wght@400;700&family=Syncopate:wght@400;700&family=Exo+2:wght@400;700&family=Chakra+Petch:wght@400;700&family=Teko:wght@400;700&family=Sarpanch:wght@400;700&family=Major+Mono+Display&family=Monoton&family=Quicksilver&display=swap" rel="stylesheet">
		<link rel="preload" href="pta.gif" as="image">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <style>
		body { margin: 0; overflow: hidden; background-color: #000; background-image: url('pta.gif'); background-repeat: repeat; background-position: top left; background-size: auto; font-family: 'Quicksand', sans-serif; color: white; cursor: none; }
		/* Ensure Quicksand applies across the UI */
		*, *::before, *::after { font-family: 'Quicksand', sans-serif !important; }
        
        /* Layout */
        #canvas-container { 
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh; 
            overflow: hidden;
            z-index: 1;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* UI Overlays */
        #overlay {
			position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.5s; backdrop-filter: blur(10px);
            cursor: default;
        }
		/* Lighter overlay when background GIF is present so it doesn't look too dark */
		#overlay.bg-lite {
			background: rgba(0,0,0,0.4);
		}
		/* Disable backdrop blur when tiling pta.gif to keep it crisp */
		#overlay.no-blur {
			backdrop-filter: none !important;
			-webkit-backdrop-filter: none !important;
		}
		/* Overlay border glow (random color set via --glowColor) */
		#overlay.glow-on {
			box-shadow: inset 0 0 60px var(--glowColor, #66ccff), 0 0 120px var(--glowColor, #66ccff);
			animation: borderGlow 2400ms ease-in-out infinite alternate;
			position: relative; /* allow border frame layering */
			border-radius: 70px; /* more rounded corners as requested */
		}
		/* Volume slider (top-center, fades like other overlays) */
		#volume-slider-container {
			position: fixed; top: 14px; left: 50%; transform: translateX(-50%);
			width: 80vw; height: 32px;
			display: none; /* hidden on start overlay; shown after playback starts */
			align-items: center; justify-content: center; z-index: 80;
			pointer-events: auto; opacity: 1; transition: opacity 1s ease-in-out;
		}
		#volume-slider {
			-webkit-appearance: none; appearance: none; width: 100%; height: 14px;
			background: rgba(255,255,255,0.08); /* almost transparent track */
			cursor: pointer; border-radius: 7px;
		}
		/* Thumb */
		#volume-slider::-webkit-slider-thumb {
			-webkit-appearance: none; appearance: none;
			width: 56px; height: 56px; border-radius: 50%;
			background: transparent url('vol.png') center center / 100% 100% no-repeat;
			border: none;
			margin-top: -21px;
		}
		#volume-slider::-moz-range-thumb {
			width: 56px; height: 56px; border-radius: 50%;
			background: transparent url('vol.png') center center / 100% 100% no-repeat;
			border: none;
		}
		/* Full-screen rounded border frame over everything */
		#border-frame {
			/* Offset by half the stroke so it extends inside and outside evenly */
			/* Push slightly further to ensure full edge coverage */
			position: fixed; top: -22.5px; left: -22.5px; right: -22.5px; bottom: -22.5px;
			/* Use a repeating GIF around the edge instead of solid black */
			border: 45px solid transparent;
			border-image-source: url('tap.gif');
			border-image-slice: 45;
			border-image-repeat: round;
			border-radius: 55px;
			/* variables for curved dissolve */
			--frameOuter: 55px;       /* matches border-radius */
			--frameStroke: 45px;      /* matches border width */
			--dissolve: 10px;         /* inner fade thickness */
			--innerR: calc(var(--frameOuter) - var(--frameStroke)); /* inner corner radius */
			--overlap: 10px;          /* push dissolve outward by a few more pixels */
			--cornerSpan: calc(var(--innerR) + var(--dissolve) + var(--overlap)); /* span consumed by corner */
			box-sizing: border-box;
			pointer-events: none;
			z-index: 100000; /* ensure frame sits above overlay glow */
			opacity: 0;
			transition: opacity 600ms ease;
		}
		#border-frame.visible { opacity: 1; }
		/* Curved inner dissolve at the inside edge of the frame */
		#border-frame::after {
			content: none; /* remove dissolve overlay */
		}
		/* Corner seam cover: solid black caps to guarantee no color gap shows */
		#border-frame::before {
			content: none; /* remove seam caps when dissolve is disabled */
		}
		@keyframes borderGlow {
			0% { box-shadow: inset 0 0 24px var(--glowColor, #66ccff), 0 0 40px var(--glowColor, #66ccff); }
			100% { box-shadow: inset 0 0 90px var(--glowColor, #66ccff), 0 0 160px var(--glowColor, #66ccff); }
		}
		/* OMNI logo shimmer */
		#logo-omni {
			color: transparent !important; /* ensure background-clip shows through */
			position: relative; display: inline-block;
			font-weight: 700;
			letter-spacing: 10px;
			text-transform: uppercase;
			margin-bottom: 0px; /* minimal gap below title */
			font-size: clamp(96px, 18vw, 280px); /* doubled size */
			text-shadow: 0 0 20px rgba(255,255,255,0.15), 0 0 24px var(--glowColor, rgba(102,204,255,0.6)), 0 0 48px var(--glowColor, rgba(102,204,255,0.35));
		}
		/* Per-letter pattern fill */
		#logo-omni .logo-letter {
			display: inline-block;
			color: transparent;
			-webkit-text-fill-color: transparent;
			-webkit-background-clip: text;
			background-clip: text;
			background-image: url('pat.gif');
			background-repeat: no-repeat; /* reuse but do not tile */
			background-position: center center;
			background-size: cover; /* fill the glyph area */
		}
		#logo-omni.logo-animate {
			animation: omniShimmer 1400ms ease forwards;
		}
		/* Persistent glow pulse around OMNI */
		#logo-omni.logo-glow {
			animation: logoGlow 2400ms ease-in-out infinite alternate;
		}
		@keyframes logoGlow {
			0% { text-shadow: 0 0 3px rgba(255,255,255,0.2), 0 0 8px var(--glowColor, #66ccff), 0 0 16px var(--glowColor, #66ccff); }
			100% { text-shadow: 0 0 16px rgba(255,255,255,0.4), 0 0 36px var(--glowColor, #66ccff), 0 0 76px var(--glowColor, #66ccff); }
		}
		@keyframes omniShimmer {
			0% { opacity: 0; transform: translateY(8px) scale(0.98); color: var(--omniColor, #66ccff); text-shadow: 0 0 0 var(--omniColor, #66ccff); }
			35% { opacity: 1; transform: translateY(0) scale(1.0); color: var(--omniColor, #66ccff); text-shadow: 0 0 16px var(--omniColor, #66ccff), 0 0 28px var(--omniColor, #66ccff); }
			70% { color: #dfefff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
			100% { color: #ffffff; text-shadow: 0 0 0 rgba(255,255,255,0); }
		}
        /* Digital transition when starting visuals */
        #overlay.digital-out {
            animation: digitalOut 520ms ease forwards;
        }
        @keyframes digitalOut {
            0% { opacity: 1; transform: none; filter: none; }
            15% { transform: translateY(-2px) skewX(-2deg); filter: contrast(120%) saturate(110%); }
            30% { transform: translateY(1px) skewX(2deg); filter: contrast(140%) saturate(120%); }
            55% { opacity: 0.6; transform: translateY(-1px) skewX(-1deg); }
            75% { opacity: 0.25; transform: translateY(0) skewX(0deg); filter: contrast(160%) saturate(130%); }
            100% { opacity: 0; transform: none; filter: none; }
        }

        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            min-height: clamp(88px, 12vh, 160px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 clamp(12px, 3vw, 40px); box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,1), transparent);
            z-index: 50;
            transition: opacity 1s ease-in-out;
            opacity: 1;
        }

        /* Center Control Group */
        .center-controls {
            display: flex; align-items: center; justify-content: center;
            gap: clamp(8px, 2vw, 24px); 
            flex-wrap: nowrap;
            flex: 1 1 auto;
            min-width: 0; /* allow shrinking */
        }

        /* Interactive Elements */
        .interactive { pointer-events: auto; cursor: pointer; }

        h1 { font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin-bottom: 30px; text-shadow: 0 0 20px rgba(255,255,255,0.2); text-align: center; }

        .control-group {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;
        }

        .btn-main {
            padding: 15px 30px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); color: #fff;
            font-size: 13px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            border-radius: 4px; min-width: 150px;
        }
        .btn-main:hover { background: #fff; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.4); border-color: #fff; }

        /* Secondary Icon Buttons (Fullscreen / Skip) */
        .icon-btn {
            background: transparent; border: none; color: rgba(255,255,255,0.6);
            font-size: clamp(18px, 2.5vw, 28px); padding: 10px; transition: 0.2s; display: flex; align-items: center;
        }
        .icon-btn:hover { color: #fff; transform: scale(1.2); text-shadow: 0 0 10px #fff; }
        /* Precise hitbox for the WebM close (‚úï) button */
        #btn-webm-close {
            width: 32px; height: 32px;
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0; line-height: 1; font-size: 20px;
            cursor: pointer; user-select: none;
        }

        .radio-input {
			padding: 15px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,20,147,1.0); color: #0f0; 
			width: 320px; border-radius: 14px; box-shadow: 0 0 18px rgba(255,20,147,0.9), 0 0 3px rgba(255,20,147,0.85);
			transition: box-shadow 220ms ease, border-color 220ms ease;
		}
		.radio-input:focus {
			outline: none; border-color: rgba(255,20,147,1.0);
			box-shadow: 0 0 24px rgba(255,20,147,0.95), 0 0 6px rgba(255,20,147,0.9);
        }

        /* Navigation Arrows */
        .nav-btn {
            font-size: clamp(36px, 6vw, 64px); opacity: 0.3; transition: 0.3s; user-select: none; padding: clamp(10px, 2vh, 20px);
        }
        .nav-btn:hover { opacity: 1; text-shadow: 0 0 15px #fff; transform: scale(1.1); }

        #mode-info { 
            text-align: center; 
            min-width: 0; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            flex: 1 1 auto; 
        }
        #mode-title { 
            font-size: clamp(16px, 2vw, 26px); 
            font-weight: 600; 
            display: inline; 
            letter-spacing: 2px; 
            margin-right: 8px; 
            text-shadow: 0 0 10px rgba(0,0,0,0.5); 
        }
		#mode-sub { 
			font-size: clamp(10px, 1.2vw, 14px); 
			color: #aaa; 
			letter-spacing: 1px; 
			display: inline; 
		}

        .hidden { opacity: 0 !important; pointer-events: none; }
        .display-none { display: none !important; }
        
		#loading-status { color: #39ff14; margin-top: 6px; font-size: 12px; height: 20px; transition: opacity 0.6s ease; }
		#shortcuts-status { 
			color: #ff1493; margin-top: 8px; font-size: 12px; min-height: 18px; 
			white-space: pre-line; text-align: center;
			position: absolute; left: 50%; transform: translateX(-50%);
			pointer-events: none; width: 86vw; max-width: 1200px; line-height: 1.35;
			overflow: hidden; /* ensure at most 3 lines visible */
			transition: opacity 0.6s ease;
		}
		/* Toggleable URL input (now sits below the title, reserves space) */
		#url-flyover {
			position: static; left: auto; transform: none;
			z-index: auto;
			margin-top: 8px;
			display: flex; align-items: center; justify-content: center;
			min-height: 56px; /* reserve space so title stays centered */
			opacity: 1; transition: opacity 260ms ease;
		}
		#url-flyover.is-hidden {
			opacity: 0; pointer-events: none;
		}

        /* Quick Radio Button (Top-right) */
        #radio-quick {
            position: absolute; 
            top: 14px; 
            right: 14px;
            z-index: 80;
            width: 80px; height: 80px;
            background-color: transparent;
            background-image: url('radio.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: contain;
            border: none;
            cursor: pointer;
            user-select: none;
            transition: opacity 1s ease-in-out;
        }
        #radio-quick:hover {
            filter: brightness(1.15);
        }
		/* Hide the radio quick button whenever the start overlay is visible */
		#overlay:not(.hidden) ~ #radio-quick { 
			display: none !important; 
		}
		/* Top bar container to align volume and radio buttons */
		#top-bar {
			position: fixed; top: 10px; left: 14px; right: 14px;
			display: none; z-index: 80;
			display: flex; align-items: center; justify-content: center;
			pointer-events: auto; opacity: 1; transition: opacity 1s ease-in-out;
		}
		/* Radio quick - large top-right button */
		#top-bar #radio-quick {
			position: absolute !important; right: 14px; top: 0;
			width: 80px !important; height: 80px !important;
			background-size: contain !important;
		}
		/* Center the volume slider and ensure it doesn't overlap the right button */
		#top-bar #volume-slider-container {
			position: absolute; left: 50%; transform: translateX(-50%);
			width: calc(100% - 140px); max-width: 80vw; height: 64px;
			display: flex; align-items: center; justify-content: center;
			min-width: 360px;
		}
        
        /* Shuffle Toggle (Top-left) */
        #shuffle-toggle {
            position: absolute; 
            top: clamp(24px, 12vh, 140px); 
            left: 14px;
            z-index: 80;
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            backdrop-filter: blur(6px);
            transition: opacity 1s ease-in-out, filter 0.2s;
            font-size: 36px;
        }
        #shuffle-toggle:hover { filter: brightness(1.15); }
        #shuffle-toggle.shuffle-on {
            border: 1px solid rgba(212,175,55,0.6);
            box-shadow: 0 0 16px rgba(212,175,55,0.25);
        }

        /* Radio Panel */
        #radio-panel {
            position: absolute; top: 54px; right: 14px;
            width: 360px; max-height: 60vh; overflow: auto;
            z-index: 90;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            transition: opacity 1s ease-in-out;
        }
        #radio-panel h3 {
            margin: 0; padding: 12px 14px; font-weight: 500; font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            letter-spacing: 1px; text-transform: uppercase; color: #ddd;
        }
        #radio-list { padding: 8px; }
        .radio-item {
            padding: 10px 12px; margin: 6px 0; border-radius: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.12);
            cursor: pointer; transition: 0.15s;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 13px;
        }
        .radio-item:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 0 20px rgba(255,255,255,0.08) inset;
        }
        .radio-item.active {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212,175,55,0.3) inset, 0 0 16px rgba(212,175,55,0.15);
            background: rgba(212,175,55,0.08);
        }

        /* Text-In sliding panel (left) */
        #textin-panel {
            position: absolute; top: 0; left: 0;
            width: 50vw; max-width: 50vw; height: 100vh; overflow: hidden;
            z-index: 90;
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0 10px 10px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            transform: translateX(-110%);
            transition: transform 0.35s ease, opacity 0.4s ease;
            opacity: 0;
            display: flex; flex-direction: column;
        }
        #textin-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        #textin-panel h3 {
            margin: 0; padding: 12px 14px; font-weight: 500; font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            letter-spacing: 1px; text-transform: uppercase; color: #ddd;
            display:flex; align-items:center; justify-content:space-between;
        }
        #textin-content { padding: 12px 12px 36px; display: grid; grid-template-columns: 1fr; gap: 12px; flex: 1; overflow: auto; box-sizing: border-box; }
        .textin-row { display:flex; gap:10px; align-items:center; }
        .textin-col { display:flex; gap:10px; }
        .textin-label { width: 88px; font-size:12px; color:#bbb; }
        .textin-input, .textin-select, .textin-color, .textin-range {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff; border-radius: 6px; padding: 10px 12px; font-size: 13px;
        }
        .textin-input { width: 100%; font-family: inherit; }
        .textin-select { min-width: 160px; }
        .textin-color { padding: 4px; height: 36px; width: 48px; }
        .textin-range { width: 100%; height: 36px; }
        .textin-btn {
            padding: 10px 16px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); color: #fff;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
            border-radius: 6px;
        }
        .textin-btn:hover { background: #fff; color: #000; }
        .slider-col { position: relative; flex: 1; height: 22px; }
        /* All three handles (min, current, max) share the same visual track line */
        .slider-col .main-range { position: absolute; inset: 0; height: 16px; z-index: 2; }
        .slider-col .range-sub { position: absolute; inset: 0; pointer-events: auto; }
        .slider-col .range-sub .sub-range { position: absolute; inset: 0; height: 16px; background: transparent; z-index: 3; }
        .btn-mini {
            padding: 4px 8px; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.06); color: #fff; border-radius: 6px;
            font-size: 11px; line-height: 1; cursor: pointer;
        }
        .btn-mini:hover { background: rgba(255,255,255,0.18); }
        #textin-preview-wrap {
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 8px; padding: 14px; min-height: 80px;
            display:flex; align-items:center; justify-content:center;
            background: rgba(0,0,0,0.3);
            margin-bottom: 18px;
        }
        #textin-preview {
            pointer-events: none; user-select: none;
            white-space: pre-wrap; text-align: center;
        }
        /* Overlay layer for rising texts */
        #text-overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 45; pointer-events: none;
        }
        .rising-text {
            position: absolute; left: 50%; transform: translate(-50%, 0);
            will-change: transform, opacity, text-shadow, filter;
            white-space: pre;
        }
        /* Mic confirm modal */
        #mic-confirm {
            position: fixed; inset: 0; z-index: 140;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center; justify-content: center;
            backdrop-filter: blur(6px);
        }
        #mic-confirm .panel {
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            min-width: 320px; max-width: 90vw;
            padding: 18px;
            color: #fff;
            text-align: center;
        }
        #mic-confirm .title {
            font-size: 16px; margin-bottom: 10px; letter-spacing: 1px;
        }
        #mic-confirm .desc {
            font-size: 12px; color: #bbb; margin-bottom: 14px;
        }
        #mic-confirm .actions { display: flex; gap: 10px; justify-content: center; }
        #mic-confirm .btn {
            padding: 10px 16px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); color: #fff;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
            border-radius: 6px; cursor: pointer;
        }
        #mic-confirm .btn:hover { background: #fff; color: #000; }

        /* Mix Settings Panel (right) */
        #mix-panel {
            position: fixed; top: 0; right: 0;
            width: 50vw; max-width: 50vw; height: 100vh; overflow: hidden;
            z-index: 120;
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px 0 0 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            transform: translateX(110%);
            transition: transform 0.35s ease, opacity 0.4s ease;
            opacity: 0; display:flex; flex-direction:column;
        }
        #mix-panel.open { transform: translateX(0); opacity: 1; }
        #mix-panel h3 {
            margin: 0; padding: 12px 14px; font-weight: 500; font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            letter-spacing: 1px; text-transform: uppercase; color: #ddd;
            display:flex; align-items:center; justify-content:space-between;
        }
        #mix-content { padding: 12px; display: grid; gap: 12px; grid-template-columns: 1fr; flex: 1; overflow: auto; }
        #mix-effects { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; }
        #mix-effects .btn {
            padding: 10px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.05); color: #fff; border-radius: 6px; font-size: 12px;
        }
        #mix-effects .btn.on {
            border-color: rgba(212,175,55,0.8);
            box-shadow: 0 0 12px rgba(212,175,55,0.25) inset;
            background: rgba(212,175,55,0.12);
        }
        .status-row { display:flex; align-items:center; gap:8px; font-size:12px; color:#bbb; }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 0 0 rgba(0,0,0,0);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .status-dot.on {
            background: #22cc66;
            box-shadow: 0 0 10px rgba(34,204,102,0.8);
        }
        .vertical-range {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* WebKit */
            appearance: slider-vertical;
            width: 26px; height: 220px;
        }
        /* Station Banner (Top-left) */
        #station-banner {
            position: absolute; top: 14px; left: 14px;
            z-index: 80;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.18);
            color: #fff;
            font-size: 18px;
            letter-spacing: 0.5px;
            pointer-events: auto;
            transition: opacity 1s ease-in-out;
            max-width: min(60vw, 720px);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #station-banner.shuffle-on {
            border: 1px solid rgba(212,175,55,0.6);
            box-shadow: 0 0 16px rgba(212,175,55,0.25);
        }
        
        /* Settings Panel */
        #settings-panel {
            position: absolute; bottom: 160px; right: 14px;
            width: 360px; max-height: 60vh; overflow: auto;
            z-index: 90;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
        }
        #settings-panel h3 {
            margin: 0; padding: 12px 14px; font-weight: 500; font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            letter-spacing: 1px; text-transform: uppercase; color: #ddd;
        }
        #settings-content { padding: 12px; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 10px 0; }
        .settings-row label { font-size: 12px; color: #ccc; }
        .settings-row input[type="number"] { width: 96px; padding: 6px 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); color: #fff; border-radius: 4px; }
        .settings-row input[type="range"] { flex: 1; }
        
        /* Unified slider styling (transparent tracks) */
        #settings-panel input[type="range"],
        #webm-settings-panel input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            background: transparent;
            cursor: pointer;
        }
        /* WebKit track */
        #settings-panel input[type="range"]::-webkit-slider-runnable-track,
        #webm-settings-panel input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: rgba(255,255,255,0.14);
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        /* WebKit thumb */
        #settings-panel input[type="range"]::-webkit-slider-thumb,
        #webm-settings-panel input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(255,255,255,0.35);
            margin-top: -4px;
            box-shadow: 0 0 8px rgba(0,0,0,0.25);
        }
        /* Firefox track */
        #settings-panel input[type="range"]::-moz-range-track,
        #webm-settings-panel input[type="range"]::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.14);
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        /* Firefox progress (filled portion) */
        #settings-panel input[type="range"]::-moz-range-progress,
        #webm-settings-panel input[type="range"]::-moz-range-progress {
            height: 6px;
            background: rgba(212,175,55,0.28); /* subtle gold on filled part */
            border-radius: 6px 0 0 6px;
        }
        /* Firefox thumb */
        #settings-panel input[type="range"]::-moz-range-thumb,
        #webm-settings-panel input[type="range"]::-moz-range-thumb {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(255,255,255,0.35);
            box-shadow: 0 0 8px rgba(0,0,0,0.25);
        }
        /* Hover/active states to increase opacity */
        #settings-panel input[type="range"]:hover::-webkit-slider-runnable-track,
        #webm-settings-panel input[type="range"]:hover::-webkit-slider-runnable-track {
            background: rgba(255,255,255,0.2);
        }
        #settings-panel input[type="range"]:active::-webkit-slider-runnable-track,
        #webm-settings-panel input[type="range"]:active::-webkit-slider-runnable-track {
            background: rgba(255,255,255,0.28);
        }
        #settings-panel input[type="range"]:hover::-moz-range-track,
        #webm-settings-panel input[type="range"]:hover::-moz-range-track {
            background: rgba(255,255,255,0.2);
        }
        #settings-panel input[type="range"]:active::-moz-range-track,
        #webm-settings-panel input[type="range"]:active::-moz-range-track {
            background: rgba(255,255,255,0.28);
        }
        .settings-note { font-size: 11px; color: #8aa; margin-top: 8px; line-height: 1.35; }
        .settings-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        .btn-small {
            padding: 8px 12px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.08); color: #fff;
            font-size: 12px; letter-spacing: 1px; border-radius: 4px;
        }
        .btn-small:hover { background: #fff; color: #000; }
        
        /* WebM Overlay */
        #webm-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 45;
            pointer-events: none;
        }
        #webm-overlay video {
            width: 50vw; height: auto; display: block;
            pointer-events: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        .webm-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            z-index: 60;
            font-size: 56px; color: rgba(255,255,255,0.7);
            background: transparent; border: none; padding: 12px; cursor: pointer;
            transition: opacity 1s ease-in-out, transform 0.2s;
            opacity: 1;
        }
        .webm-nav:hover { color: #fff; text-shadow: 0 0 15px #fff; transform: translateY(-50%) scale(1.1); }
        #webm-prev { left: 14px; }
        #webm-next { right: 14px; }
        
        /* WebM Settings Panel (mirror of settings-panel) */
        #webm-settings-panel {
            position: absolute; bottom: 160px; left: 14px;
            width: 360px; max-height: 60vh; overflow: auto;
            z-index: 90;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
        }
        #webm-settings-panel h3 {
            margin: 0; font-weight: 500; font-size: 14px;
            letter-spacing: 1px; text-transform: uppercase; color: #ddd;
        }
        #webm-settings-panel .panel-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        #webm-settings-content { padding: 12px; }
        .settings-row input[type="range"] { flex: 1; }

		/* Top Menu Panel (slides from top, 50vh) */
		#top-menu-panel {
			position: fixed; top: 0; left: 0; right: 0; height: 50vh;
			z-index: 95;
			background: rgba(0,0,0,0.8);
			border-bottom: 1px solid rgba(255,255,255,0.2);
			backdrop-filter: blur(10px);
			box-shadow: 0 10px 30px rgba(0,0,0,0.6);
			transform: translateY(-100%);
			transition: transform 0.35s ease-in-out, opacity 0.2s ease-in-out;
			opacity: 0; pointer-events: none;
			display: flex; flex-direction: column;
		}
		#top-menu-panel.open {
			transform: translateY(0);
			opacity: 1; pointer-events: auto;
		}
		#top-menu-header {
			display: flex; align-items: center; justify-content: space-between;
			padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.12);
		}
		#top-menu-content { padding: 12px; display: grid; gap: 10px; grid-template-columns: 1fr; flex: 1; overflow: auto; }
		#top-menu-actions { display: grid; gap: 8px; grid-template-columns: repeat(4, minmax(0, 1fr)); }
		#top-menu-webm { display: grid; gap: 8px; grid-template-columns: minmax(0,1fr) auto auto; align-items: center; }
		#top-menu-content .row { display: flex; gap: 8px; align-items: center; }
		#top-menu-content input[type="text"] {
			flex: 1; padding: 10px 12px; background: rgba(255,255,255,0.06);
			border: 1px solid rgba(255,255,255,0.25); color: #fff; border-radius: 8px;
		}
		#top-menu-content .btn {
			padding: 8px 12px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.08); color: #fff;
			font-size: 12px; letter-spacing: 1px; border-radius: 6px; cursor: pointer;
		}
		#top-menu-content .btn:hover { background: #fff; color: #000; }
		/* Footer with volume slider pinned to the bottom of the panel */
		#top-menu-footer { padding: 8px 14px; border-top: 1px solid rgba(255,255,255,0.12); }
		#top-menu-footer #volume-slider-container {
			/* Override global fixed/top styles so it lives inside the panel footer */
			position: static; left: auto; top: auto; transform: none; z-index: auto;
			display:flex; align-items:center; justify-content: center; width:100%; height:48px;
			opacity: 1 !important; pointer-events: auto;
		}
		/* Themed select (WebM dropdown) */
		#avatar-webm-select {
			appearance: none; -webkit-appearance: none; -moz-appearance: none;
			padding: 0 12px; min-width: 220px;
			background: rgba(255,255,255,0.06);
			border: 1px solid rgba(255,255,255,0.25);
			color: #fff; border-radius: 8px;
			flex: 1; min-width: 0; width: auto; max-width: 100%;
			height: 42px; box-sizing: border-box;
		}
		#avatar-webm-select:focus { outline: none; border-color: rgba(255,255,255,0.45); }
		/* Allow left header group to expand, enabling the select to stretch */
		#bottom-avatar-header > div:first-child { flex: 1; min-width: 0; }
		/* Add a bit of spacing before the right-side controls group */
		#bottom-avatar-header > div:last-child { margin-left: 10px; flex-shrink: 0; }
		/* Enlarge all buttons on the Avatar Settings top line by ~50% with rounded corners */
		#bottom-avatar-header .btn {
			font-size: 1.5em;
			height: 42px;
			padding: 0 16px;
			border-radius: 10px;
			display: inline-flex; align-items: center; justify-content: center;
			line-height: 1; box-sizing: border-box;
			/* Theme colors (avoid white buttons) */
			background: rgba(255,255,255,0.08);
			border: 1px solid rgba(255,255,255,0.25);
			color: #fff;
			cursor: pointer;
			transition: background 160ms ease;
		}
		#bottom-avatar-header .btn:hover { background: rgba(212,175,55,0.28); color: #fff; }
		/* Icon buttons after the WebM dropdown: make square with rounded corners */
		#avatar-webm-open,
		#avatar-webm-prev,
		#avatar-webm-next,
		#btn-bottommenu-close {
			width: 42px; height: 42px;
			padding: 0;
			display: inline-flex; align-items: center; justify-content: center;
			border-radius: 10px;
			line-height: 1;
		}
		/* Ensure right-side header buttons use the same theme */
		#avatar-btn-auto,
		#avatar-btn-reset,
		#btn-bottommenu-close {
			background: rgba(255,255,255,0.08);
			border: 1px solid rgba(255,255,255,0.25);
			color: #fff;
		}
		/* Auto toggle "on" state uses text color only */
		#avatar-btn-auto.on,
		#btn-webm-auto.on {
			color: #ffd700;
		}
		#avatar-btn-auto:hover,
		#avatar-btn-reset:hover,
		#btn-bottommenu-close:hover {
			background: rgba(212,175,55,0.28);
			color: #fff;
		}
		/* Scrollbar styling for stations list */
		#top-menu-stations {
			scrollbar-color: rgba(255,255,255,0.35) rgba(255,255,255,0.08);
			scrollbar-width: thin;
		}
		#top-menu-stations::-webkit-scrollbar { width: 10px; height: 10px; }
		#top-menu-stations::-webkit-scrollbar-track { background: rgba(255,255,255,0.06); border-radius: 8px; }
		#top-menu-stations::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.32); border-radius: 8px; border: 2px solid rgba(0,0,0,0.15); }
		#top-menu-stations::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.45); }
		/* Make the volume slider clearly visible inside the top menu footer */
		#top-menu-footer #volume-slider {
			height: 16px;
			background: rgba(255,255,255,0.18);
			border-radius: 8px;
		}
		#top-menu-footer #volume-slider::-webkit-slider-runnable-track {
			height: 6px; background: rgba(255,255,255,0.24); border-radius: 6px;
		}
		#top-menu-footer #volume-slider::-moz-range-track {
			height: 6px; background: rgba(255,255,255,0.24); border-radius: 6px;
		}
		#top-menu-footer #volume-slider::-moz-range-progress {
			height: 6px; background: rgba(212,175,55,0.35); border-radius: 6px 0 0 6px;
		}
		/* Unify slider style across panels to match volume theme (track color, thumb style) */
		#top-menu-content input[type="range"],
        #mix-content input[type="range"],
        #textin-content input[type="range"],
		#bottom-avatar-content input[type="range"],
		#settings-panel input[type="range"],
		#webm-settings-panel input[type="range"] {
			-webkit-appearance: none; appearance: none;
			height: 16px; background: transparent; cursor: pointer;
		}
        #top-menu-content input[type="range"]::-webkit-slider-runnable-track,
        #mix-content input[type="range"]::-webkit-slider-runnable-track,
        #textin-content input[type="range"]::-webkit-slider-runnable-track,
		#bottom-avatar-content input[type="range"]::-webkit-slider-runnable-track,
		#settings-panel input[type="range"]::-webkit-slider-runnable-track,
		#webm-settings-panel input[type="range"]::-webkit-slider-runnable-track {
			height: 6px; background: rgba(255,255,255,0.24); border-radius: 6px;
		}
        #top-menu-content input[type="range"]::-moz-range-track,
        #mix-content input[type="range"]::-moz-range-track,
        #textin-content input[type="range"]::-moz-range-track,
		#bottom-avatar-content input[type="range"]::-moz-range-track,
		#settings-panel input[type="range"]::-moz-range-track,
		#webm-settings-panel input[type="range"]::-moz-range-track {
			height: 6px; background: rgba(255,255,255,0.24); border-radius: 6px;
		}
        #top-menu-content input[type="range"]::-moz-range-progress,
        #mix-content input[type="range"]::-moz-range-progress,
        #textin-content input[type="range"]::-moz-range-progress,
		#bottom-avatar-content input[type="range"]::-moz-range-progress,
		#settings-panel input[type="range"]::-moz-range-progress,
		#webm-settings-panel input[type="range"]::-moz-range-progress {
			height: 6px; background: rgba(212,175,55,0.35); border-radius: 6px 0 0 6px;
		}
        #top-menu-content input[type="range"]::-webkit-slider-thumb,
        #mix-content input[type="range"]::-webkit-slider-thumb,
        #textin-content input[type="range"]::-webkit-slider-thumb,
		#bottom-avatar-content input[type="range"]::-webkit-slider-thumb,
		#settings-panel input[type="range"]::-webkit-slider-thumb,
		#webm-settings-panel input[type="range"]::-webkit-slider-thumb {
			-webkit-appearance: none; appearance: none;
			width: 14px; height: 14px; border-radius: 50%;
			background: rgba(0,0,0,0.9); /* black thumb */
			border: 2px solid rgba(212,175,55,0.9); /* gold border */
			margin-top: -4px;
			box-shadow: 0 0 8px rgba(0,0,0,0.25);
		}
        #top-menu-content input[type="range"]::-moz-range-thumb,
        #mix-content input[type="range"]::-moz-range-thumb,
        #textin-content input[type="range"]::-moz-range-thumb,
		#bottom-avatar-content input[type="range"]::-moz-range-thumb,
		#settings-panel input[type="range"]::-moz-range-thumb,
		#webm-settings-panel input[type="range"]::-moz-range-thumb {
			width: 14px; height: 14px; border-radius: 50%;
			background: rgba(0,0,0,0.9); /* black thumb */
			border: 2px solid rgba(212,175,55,0.9); /* gold border */
			box-shadow: 0 0 8px rgba(0,0,0,0.25);
		}

		/* Bottom Avatar Menu Panel (slides from bottom, 50vh) */
		#bottom-avatar-panel {
			position: fixed; left: 0; right: 0; bottom: 0; height: 50vh;
			z-index: 95;
			background: rgba(0,0,0,0.8);
			border-top: 1px solid rgba(255,255,255,0.2);
			backdrop-filter: blur(10px);
			box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
			transform: translateY(100%);
			transition: transform 0.35s ease-in-out, opacity 0.2s ease-in-out;
			opacity: 0; pointer-events: none;
			display: flex; flex-direction: column;
		}
		#bottom-avatar-panel.open {
			transform: translateY(0);
			opacity: 1; pointer-events: auto;
		}
		#bottom-avatar-header {
			display: flex; align-items: center; justify-content: space-between;
			padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.12);
		}
		#bottom-avatar-content { padding: 12px; display: grid; gap: 10px; grid-template-columns: 1fr; flex: 1; overflow: auto; }
		#bottom-avatar-actions { display: grid; gap: 8px; grid-template-columns: minmax(0,1fr) auto auto; align-items: center; }
		#bottom-avatar-content .row { display: flex; gap: 8px; align-items: center; }
		#bottom-avatar-content input[type="range"] {
			flex: 1; padding: 0; background: rgba(255,255,255,0.06);
		}
		#bottom-avatar-content .btn {
			padding: 8px 12px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.08); color: #fff;
			font-size: 12px; letter-spacing: 1px; border-radius: 6px; cursor: pointer;
		}
		#bottom-avatar-content .btn:hover { background: #fff; color: #000; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
                "butterchurn": "https://esm.sh/butterchurn@2.6.0",
                "butterchurn-presets": "https://esm.sh/butterchurn-presets@2.4.7",
                "lodash": "https://esm.sh/lodash@4.17.21"
            }
        }
    </script>
</head>
<body>

    <!-- START SCREEN -->
	<div id="overlay" class="no-blur bg-lite">
		<h1 id="logo-omni" data-text="OMNI&gt;"><span class="logo-letter logo-o">O</span><span class="logo-letter logo-m">M</span><span class="logo-letter">N</span><span class="logo-letter logo-start">I</span><span class="logo-letter logo-start">&gt;</span></h1>
		<!-- Toggle URL input (shown via clicking 'N' in OMNI>) -->
		<div id="url-flyover" class="is-hidden">
            <input type="text" id="radio-url" class="radio-input interactive" value="https://stream.bigfm.de/tomorrowland/mp3-128/" placeholder="Paste Stream URL">
        </div>

        <div class="control-group">
            <input type="file" id="file-input" accept="audio/*" style="display:none">
        </div>

        <div id="loading-status">Select a source to begin</div>
        <div id="shortcuts-status"></div>
    </div>
    <!-- Mic confirmation modal -->
    <div id="mic-confirm">
        <div class="panel">
            <div class="title">Microphone Audio Input?</div>
            <div class="desc">This will request access to your microphone and use it as the audio source.</div>
            <div class="actions">
                <button id="btn-mic-ok" class="btn">Okay</button>
                <button id="btn-mic-cancel" class="btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- HUD (Fades out when idle) -->
    <div id="ui-layer" class="hidden">
        <div class="nav-btn interactive" id="btn-prev">‚ùÆ</div>

        <div class="center-controls">
            <!-- SKIP PRESET BUTTON (Only for ProjectM) -->
            <button class="icon-btn interactive display-none" id="btn-skip-preset" title="Next Visual Preset">‚è≠</button>
            <!-- WEBM TOGGLE -->
            <button class="icon-btn interactive" id="btn-webm" title="Toggle WebM Overlay">üéõÔ∏è</button>

            <!-- TITLE INFO -->
            <div id="mode-info">
                <span id="mode-title">INIT</span>
                <span id="mode-sub">Engine Ready</span>
            </div>

            <!-- SETTINGS BUTTON -->
            <button class="icon-btn interactive" id="btn-settings" title="Visualizer Settings">üéöÔ∏è</button>
            
        </div>

        <div class="nav-btn interactive" id="btn-next">‚ùØ</div>
    </div>

    <div id="canvas-container"></div>
    <audio id="radio-element" crossorigin="anonymous"></audio>
    <audio id="radio-element-b" crossorigin="anonymous"></audio>
	<!-- Top bar aligns shuffle, volume, and radio controls -->
	<div id="top-bar" class="display-none"></div>
	<!-- Top Menu Panel -->
	<div id="top-menu-panel" class="display-none">
		<div id="top-menu-content">
			<!-- Scrollable Radio Stations List (migrated from Radio Panel) -->
			<div id="top-menu-stations" style="flex:1; overflow:auto; border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px; background: rgba(255,255,255,0.04);">
				<div id="radio-list"></div>
			</div>
			<!-- Single-row visualization sliders (minimal labels), above volume slider -->
			<div class="row" style="display:grid; grid-template-columns: auto 1fr auto 1fr auto 1fr auto 1fr; gap:10px; align-items:center; margin-top:8px; width:100%;">
				<label for="tm-inp-shuffle-min" style="font-size:11px; color:#ccc; min-width:28px; text-align:right">Min</label>
				<input id="tm-inp-shuffle-min" type="range" min="3" max="120" step="1" value="30" style="width:100%;">
				<label for="tm-inp-shuffle-max" style="font-size:11px; color:#ccc; min-width:28px; text-align:right">Max</label>
				<input id="tm-inp-shuffle-max" type="range" min="5" max="180" step="1" value="60" style="width:100%;">
				<label for="tm-inp-transition" style="font-size:11px; color:#ccc; min-width:36px; text-align:right">Trans</label>
				<input id="tm-inp-transition" type="range" min="0" max="10" step="0.1" value="2.7" style="width:100%;">
				<label for="tm-inp-pixelratio" style="font-size:11px; color:#ccc; min-width:20px; text-align:right">PR</label>
				<input id="tm-inp-pixelratio" type="range" min="0.5" max="3" step="0.1" value="1" style="width:100%;">
			</div>
			<div id="top-menu-actions">
				<button class="btn" id="topmenu-prev-station" title="Previous Station">‚üµ Station</button>
				<button class="btn" id="topmenu-next-station" title="Next Station">Station ‚ü∂</button>
				<button class="btn" id="topmenu-prev-visual" title="Previous Visual">‚üµ Visual</button>
				<button class="btn" id="topmenu-next-visual" title="Next Visual">Visual ‚ü∂</button>
			</div>
			<!-- footer with volume slider will be appended below -->
		</div>
		<div id="top-menu-footer">
			<div id="volume-slider-container" class="interactive">
				<input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.2">
			</div>
		</div>
	</div>
	<!-- Bottom Avatar Menu Panel -->
	<div id="bottom-avatar-panel" class="display-none">
		<div id="bottom-avatar-header">
			<div style="display:flex; gap:10px; align-items:center">
				<h3>WEBM‚ñπ</h3>
				<select id="avatar-webm-select"></select>
				<button class="btn" id="avatar-webm-open" title="Open selected WebM">‚ñ∂</button>
				<div style="display:flex; gap:6px;">
					<button class="btn" id="avatar-webm-prev" title="Prev WebM">‚ü®</button>
					<button class="btn" id="avatar-webm-next" title="Next WebM">‚ü©</button>
				</div>
			</div>
			<div style="display:flex; gap:8px; align-items:center">
				<button class="btn" id="avatar-btn-auto" title="Toggle random WebM (30-60s)">Auto</button>
				<button class="btn" id="avatar-btn-reset" title="Reset to defaults">‚éã</button>
				<button class="btn" id="btn-bottommenu-close" title="Close">‚úï</button>
			</div>
		</div>
		<div id="bottom-avatar-content">
			<div class="row">
				<label for="avatar-inp-scale" style="min-width:120px; font-size:12px; color:#ccc">Size (vw)</label>
				<input id="avatar-inp-scale" type="range" min="10" max="200" step="1" value="50">
			</div>
			<div class="row">
				<label for="avatar-inp-x" style="min-width:120px; font-size:12px; color:#ccc">X (vw)</label>
				<input id="avatar-inp-x" type="range" min="0" max="100" step="1" value="50">
			</div>
			<div class="row">
				<label for="avatar-inp-y" style="min-width:120px; font-size:12px; color:#ccc">Y (vh)</label>
				<input id="avatar-inp-y" type="range" min="0" max="100" step="1" value="50">
			</div>
			<div class="row">
				<label for="avatar-inp-rot" style="min-width:120px; font-size:12px; color:#ccc">Rotate (deg)</label>
				<input id="avatar-inp-rot" type="range" min="-180" max="180" step="1" value="0">
			</div>
			<div class="row">
				<label for="avatar-inp-speed" style="min-width:120px; font-size:12px; color:#ccc">Speed</label>
				<input id="avatar-inp-speed" type="range" min="0.1" max="4" step="0.1" value="1.0">
			</div>
			<div class="row">
				<label for="avatar-inp-opacity" style="min-width:120px; font-size:12px; color:#ccc">Opacity</label>
				<input id="avatar-inp-opacity" type="range" min="0" max="1" step="0.01" value="0.82">
			</div>
			<div class="row">
				<label for="avatar-inp-dup" style="min-width:120px; font-size:12px; color:#ccc">Duplicates (0-2)</label>
				<input id="avatar-inp-dup" type="range" min="0" max="2" step="1" value="0">
			</div>
		</div>
	</div>
    <!-- Quick Radio Button and old Radio Panel removed (assets retained) -->
    <div id="station-banner" class="display-none"></div>
    <!-- Rising text overlay layer -->
    <div id="text-overlay-layer"></div>
    <!-- Text-In Panel -->
    <div id="textin-panel" class="display-none" aria-label="Text-In Panel">
        <h3>
            <span>TEXT-IN</span>
            <button class="textin-btn interactive" id="ti-send" style="margin-left:auto; margin-right:8px">Send</button>
            <button class="icon-btn interactive" id="btn-textin-close" title="Close" aria-label="Close">‚úï</button>
        </h3>
        <div id="textin-content">
            <div class="textin-row">
                <div class="textin-label">Text</div>
                <input type="text" id="ti-text" class="textin-input" value="LuckyüçÄRadio" placeholder="Your message...">
            </div>
            <div class="textin-row">
                <div class="textin-label">Font</div>
                <select id="ti-font" class="textin-select">
                    <option value="'Segoe UI', sans-serif">Segoe UI</option>
                    <option value="Arial, Helvetica, sans-serif">Arial</option>
                    <option value="'Courier New', Courier, monospace">Courier New</option>
                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    <option value="Georgia, 'Times New Roman', serif">Georgia</option>
                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                    <option value="Roboto, sans-serif">Roboto</option>
                    <option value="Oswald, sans-serif">Oswald</option>
                    <option value="Montserrat, sans-serif">Montserrat</option>
                    <option value="Raleway, sans-serif">Raleway</option>
                    <option value="Poppins, sans-serif">Poppins</option>
                    <option value="Orbitron, sans-serif">Orbitron</option>
                    <option value="Audiowide, cursive">Audiowide</option>
                    <option value="'Share Tech Mono', monospace">Share Tech Mono</option>
                    <option value="VT323, monospace">VT323</option>
                    <option value="Electrolize, sans-serif">Electrolize</option>
                    <option value="Oxanium, cursive">Oxanium</option>
                    <option value="Quantico, sans-serif">Quantico</option>
                    <option value="Syncopate, sans-serif">Syncopate</option>
                    <option value="'Exo 2', sans-serif">Exo 2</option>
                    <option value="'Chakra Petch', sans-serif">Chakra Petch</option>
                    <option value="Teko, sans-serif">Teko</option>
                    <option value="Sarpanch, sans-serif">Sarpanch</option>
                    <option value="'Major Mono Display', monospace">Major Mono Display</option>
                    <option value="Monoton, cursive">Monoton</option>
                    <option value="Quicksilver, cursive">Quicksilver</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="Lobster, cursive" selected>Lobster</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="Nunito, sans-serif">Nunito</option>
                    <option value="Merriweather, serif">Merriweather</option>
                    <option value="Rubik, sans-serif">Rubik</option>
                    <option value="Inter, sans-serif">Inter</option>
                    <option value="'Fira Sans', sans-serif">Fira Sans</option>
                    <option value="'Fira Mono', monospace">Fira Mono</option>
                    <option value="Inconsolata, monospace">Inconsolata</option>
                    <option value="'Source Code Pro', monospace">Source Code Pro</option>
                    <option value="'Press Start 2P', cursive">Press Start 2P</option>
                </select>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb; margin-left:8px">
                    <input type="checkbox" id="ti-font-rand" title="Random Font">
                </label>
            </div>
            <div class="textin-row">
                <div class="textin-label">Color</div>
                <input type="color" id="ti-color" class="textin-color" value="#ffffff">
                <button id="ti-color-rand" class="btn-mini" title="Random color">üé≤</button>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb">
                    <input type="checkbox" id="ti-color-rand-check" title="Random Color">
                </label>
                <div class="textin-label">Size</div>
                <div class="slider-col">
                    <input type="range" id="ti-size" class="textin-range main-range" min="16" max="200" value="64">
                    <div class="range-sub">
                        <input type="range" id="ti-size-rmin" class="textin-range sub-range" min="16" max="200" value="16" step="1" title="Min Size">
                        <input type="range" id="ti-size-rmax" class="textin-range sub-range" min="16" max="200" value="200" step="1" title="Max Size">
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb">
                    <input type="checkbox" id="ti-size-rand" checked title="Random Size">
                </label>
            </div>
            <div class="textin-row">
                <div class="textin-label">X Position</div>
                <div class="slider-col">
                    <input type="range" id="ti-x" class="textin-range main-range" min="0" max="100" value="50">
                    <div class="range-sub">
                        <input type="range" id="ti-x-rmin" class="textin-range sub-range" min="0" max="100" value="0" step="1" title="Min X (%)">
                        <input type="range" id="ti-x-rmax" class="textin-range sub-range" min="0" max="100" value="100" step="1" title="Max X (%)">
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb">
                    <input type="checkbox" id="ti-x-rand" checked title="Random X">
                </label>
            </div>
            <div class="textin-row">
                <div class="textin-label">Border</div>
                <div class="slider-col">
                    <input type="range" id="ti-border" class="textin-range main-range" min="0" max="10" value="2">
                    <div class="range-sub">
                        <input type="range" id="ti-border-rmin" class="textin-range sub-range" min="0" max="10" value="0" step="1" title="Min Border">
                        <input type="range" id="ti-border-rmax" class="textin-range sub-range" min="0" max="10" value="10" step="1" title="Max Border">
                    </div>
                </div>
                <input type="color" id="ti-border-color" class="textin-color" value="#000000">
                <button id="ti-border-color-rand" class="btn-mini" title="Random border color">üé≤</button>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb">
                    <input type="checkbox" id="ti-border-color-rand-check" title="Random Border Color" checked>
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb">
                    <input type="checkbox" id="ti-border-rand" title="Random Border">
                </label>
            </div>
            <div class="textin-row">
                <div class="textin-label">Glow</div>
                <div class="slider-col">
                    <input type="range" id="ti-glow" class="textin-range main-range" min="0" max="50" value="12">
                    <div class="range-sub">
                        <input type="range" id="ti-glow-rmin" class="textin-range sub-range" min="0" max="50" value="0" step="1" title="Min Glow">
                        <input type="range" id="ti-glow-rmax" class="textin-range sub-range" min="0" max="50" value="50" step="1" title="Max Glow">
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb; margin-left:8px">
                    <input type="checkbox" id="ti-glow-rand" title="Random Glow">
                </label>
                <input type="color" id="ti-glow-color" class="textin-color" value="#00ffff" title="Glow Color">
                <button id="ti-glow-color-rand" class="btn-mini" title="Random glow color">üé≤</button>
            </div>
            <div class="textin-row">
                <div class="textin-label">Flashing</div>
                <input type="checkbox" id="ti-flash">
                <div class="textin-label">Flash Speed</div>
                <div class="slider-col">
                    <input type="range" id="ti-flash-speed" class="textin-range main-range" min="0" max="5" value="1" step="0.1">
                    <div class="range-sub">
                        <input type="range" id="ti-flashspeed-rmin" class="textin-range sub-range" min="0" max="5" value="0" step="0.1" title="Min Flash Speed">
                        <input type="range" id="ti-flashspeed-rmax" class="textin-range sub-range" min="0" max="5" value="5" step="0.1" title="Max Flash Speed">
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb; margin-left:8px">
                    <input type="checkbox" id="ti-flashspeed-rand" title="Random Flash Speed">
                </label>
            </div>
            <div class="textin-row">
                <div class="textin-label">Rise Speed</div>
                <div class="slider-col">
                    <input type="range" id="ti-speed" class="textin-range main-range" min="25" max="1200" value="25">
                    <div class="range-sub">
                        <input type="range" id="ti-speed-rmin" class="textin-range sub-range" min="25" max="1200" value="25" step="1" title="Min Rise Speed">
                        <input type="range" id="ti-speed-rmax" class="textin-range sub-range" min="25" max="1200" value="1200" step="1" title="Max Rise Speed">
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#bbb; margin-left:8px">
                    <input type="checkbox" id="ti-speed-rand" title="Random Speed" checked>
                </label>
            </div>
            <div id="textin-preview-wrap">
                <div id="textin-preview">Preview</div>
            </div>
        </div>
    </div>
    <!-- Mix Settings Panel (right) -->
    <div id="mix-panel" class="display-none" aria-label="Mix Settings">
        <h3>
            <span>Mix Settings</span>
            <button class="icon-btn interactive" id="btn-mix-close" title="Close" aria-label="Close">‚úï</button>
        </h3>
        <div id="mix-content">
            <div>
                <div style="font-size:12px; color:#bbb; margin-bottom:6px">Effects</div>
                <div id="mix-effects">
                    <button class="btn" id="fx-lowpass">Lowpass</button>
                    <button class="btn" id="fx-highpass">Highpass</button>
                    <button class="btn" id="fx-bass">Bass Boost</button>
                    <button class="btn" id="fx-treble">Treble Boost</button>
                    <button class="btn" id="fx-echo">Echo</button>
                    <button class="btn" id="fx-distort">Distortion</button>
                    <button class="btn" id="fx-arp">Arpitagor</button>
                    <button class="btn" id="fx-tk">TK Filter</button>
                    <button class="btn" id="fx-wav" title="Left-click: play once ‚Ä¢ Right-click: loop">Wav</button>
                    <button class="btn" id="fx-wav1" title="Left-click: play once ‚Ä¢ Right-click: loop">Wav1</button>
                    <button class="btn" id="fx-wav2" title="Left-click: play once ‚Ä¢ Right-click: loop">Wav2</button>
                    <button class="btn" id="fx-wav3" title="Left-click: play once ‚Ä¢ Right-click: loop">Wav3</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap: 12px; align-items:flex-start">
                <div>
                    <div style="font-size:12px; color:#bbb; margin-bottom:6px">Second Station</div>
                    <select id="mix-station-b" class="textin-select" style="width: 100%"></select>
                    <div style="display:flex; gap:8px; margin-top:8px">
                        <button class="btn" id="mix-b-play">Play B</button>
                        <button class="btn" id="mix-b-stop">Stop B</button>
                    </div>
                    <div class="status-row" style="margin-top:6px">
                        <div id="mix-b-status-dot" class="status-dot"></div>
                        <div id="mix-b-status-text">B: Stopped</div>
                    </div>
                </div>
            </div>
            <div id="mix-cross-row" style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:6px">
                <div style="font-size:16px; color:#bbb">CrossfaderüéöÔ∏è</div>
                <input type="range" id="mix-crossfader" min="0" max="1" step="0.01" value="0" style="width:100%">
                <div style="display:flex; width:100%; justify-content:space-between; font-size:11px; color:#888">
                    <span>A</span><span>B</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WebM Overlay + Nav -->
    <div id="webm-overlay" class="display-none">
        <video id="webm-video" muted loop playsinline></video>
        <video id="webm-video-left" muted loop playsinline class="display-none"></video>
        <video id="webm-video-right" muted loop playsinline class="display-none"></video>
    </div>
    <button id="webm-prev" class="webm-nav display-none" title="Previous video">‚ùÆ</button>
    <button id="webm-next" class="webm-nav display-none" title="Next video">‚ùØ</button>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="display-none">
        <h3>Visualizer Settings</h3>
        <div id="settings-content">
            <div class="settings-row">
                <label for="inp-shuffle-min">Shuffle min (s)</label>
                <input id="inp-shuffle-min" type="range" min="3" max="120" step="1" value="30">
            </div>
            <div class="settings-row">
                <label for="inp-shuffle-max">Shuffle max (s)</label>
                <input id="inp-shuffle-max" type="range" min="5" max="180" step="1" value="60">
            </div>
            <div class="settings-row">
                <label for="inp-transition">Transition (s)</label>
                <input id="inp-transition" type="range" min="0" max="10" step="0.1" value="2.7">
            </div>
            <div class="settings-row">
                <label for="inp-pixelratio">Pixel Ratio</label>
                <input id="inp-pixelratio" type="range" min="0.5" max="3" step="0.1" value="1">
            </div>
            <div class="settings-note">Settings apply to ProjectM v2. Shuffle times are randomized between min and max. Transition affects preset morph duration. Pixel ratio applies on next init.</div>
            <div class="settings-actions">
                <button class="btn-small" id="btn-settings-apply">Apply</button>
                <button class="btn-small" id="btn-settings-close">Close</button>
            </div>
        </div>
    </div>
    
    <!-- WebM Settings Panel -->
    <div id="webm-settings-panel" class="display-none">
        <div class="panel-head">
            <h3>AVATAR SETTINGS</h3>
            <div style="display:flex; gap:8px; align-items:center">
                <button class="btn-small" id="btn-webm-auto" title="Toggle random WebM (30-60s)">Auto</button>
                <button class="btn-small" id="btn-webm-reset" title="Reset to defaults">‚éã</button>
                <button class="icon-btn interactive" id="btn-webm-close" title="Close" aria-label="Close" onclick="hideWebmSettingsPanel && hideWebmSettingsPanel()">‚úï</button>
            </div>
        </div>
        <div id="webm-settings-content">
            <div class="settings-row">
                <label for="inp-webm-scale">Size (vw)</label>
                <input id="inp-webm-scale" type="range" min="10" max="200" step="1" value="50">
            </div>
            <div class="settings-row">
                <label for="inp-webm-x">X (vw)</label>
                <input id="inp-webm-x" type="range" min="0" max="100" step="1" value="50">
            </div>
            <div class="settings-row">
                <label for="inp-webm-y">Y (vh)</label>
                <input id="inp-webm-y" type="range" min="0" max="100" step="1" value="50">
            </div>
            <div class="settings-row">
                <label for="inp-webm-rot">Rotate (deg)</label>
                <input id="inp-webm-rot" type="range" min="-180" max="180" step="1" value="0">
            </div>
            <div class="settings-row">
                <label for="inp-webm-speed">Speed</label>
                <input id="inp-webm-speed" type="range" min="0.1" max="4" step="0.1" value="1.0">
            </div>
            <div class="settings-row">
                <label for="inp-webm-opacity">Opacity</label>
                <input id="inp-webm-opacity" type="range" min="0" max="1" step="0.01" value="0.82">
            </div>
            <div class="settings-row">
                <label for="inp-webm-dup">Duplicates (0-2)</label>
                <input id="inp-webm-dup" type="range" min="0" max="2" step="1" value="0">
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { AfterimagePass } from 'three/addons/postprocessing/AfterimagePass.js';
        import { SimplexNoise } from 'three/addons/math/SimplexNoise.js';
        import butterchurn from 'butterchurn';
        import butterchurnPresets from 'butterchurn-presets';

        // --- GLOBAL STATE ---
        const state = {
            audioCtx: null,
            sourceNode: null,
            analyserNode: null,
            isPlaying: false,
            currentModeIdx: 0,
            activeVisualizer: null,
            idleTimer: null,
            mediaStream: null
        };

        const container = document.getElementById('canvas-container');
        const statusEl = document.getElementById('loading-status');
        const uiLayer = document.getElementById('ui-layer');
        const radioQuickBtn = document.getElementById('radio-quick');
        const radioPanel = document.getElementById('radio-panel');
        const radioListEl = document.getElementById('radio-list');
        const radioInputEl = document.getElementById('radio-url') || document.getElementById('station-url');
        const audioEl = document.getElementById('radio-element');
        const audioElB = document.getElementById('radio-element-b');
        const stationBanner = document.getElementById('station-banner');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsBtn = document.getElementById('btn-settings');
        const settingsApplyBtn = document.getElementById('btn-settings-apply');
        const settingsCloseBtn = document.getElementById('btn-settings-close');
        // Text-In refs/state
        const textInPanel = document.getElementById('textin-panel');
        const textOverlayLayer = document.getElementById('text-overlay-layer');
        const tiText = document.getElementById('ti-text');
        const tiFont = document.getElementById('ti-font');
